# EzMonitor SDK

ä¸€ç«™å¼å‰ç«¯ç›‘æ§è§£å†³æ–¹æ¡ˆï¼Œæä¾›æ€§èƒ½ç›‘æ§ã€é”™è¯¯ç›‘æ§ã€ç”¨æˆ·è¡Œä¸ºåˆ†æç­‰å…¨æ–¹ä½çš„å‰ç«¯ç›‘æ§èƒ½åŠ›ã€‚

## ğŸš€ åŠŸèƒ½ç‰¹æ€§

- **ğŸ” PVç›‘æ§**ï¼šé¡µé¢è®¿é—®é‡ç»Ÿè®¡ï¼Œæ”¯æŒSPAè·¯ç”±ç›‘æ§ï¼Œå®æ—¶æµé‡åˆ†æ
- **âš¡ æ€§èƒ½ç›‘æ§**ï¼šè·å–é¡µé¢åŠ è½½æ€§èƒ½æ•°æ®ï¼ŒåŒ…æ‹¬FCPã€LCPç­‰æ ¸å¿ƒæŒ‡æ ‡
- **ğŸ› é”™è¯¯ç›‘æ§**ï¼šæ•è·JavaScripté”™è¯¯ã€èµ„æºåŠ è½½é”™è¯¯ã€Promiseæœªæ•è·å¼‚å¸¸
- **ğŸ¯ ç”¨æˆ·è¡Œä¸ºåˆ†æ**ï¼šè®°å½•ç”¨æˆ·ç‚¹å‡»ã€è·¯ç”±è·³è½¬ã€è‡ªå®šä¹‰åŸ‹ç‚¹ç­‰äº¤äº’è¡Œä¸º
- **ğŸ¬ é”™è¯¯å½•å±å›æ”¾**ï¼šåŸºäºrrwebçš„ç”¨æˆ·æ“ä½œå½•åˆ¶ï¼Œé”™è¯¯ç°åœºå®Œç¾è¿˜åŸ
- **ğŸ› ï¸ æ¡†æ¶æ”¯æŒ**ï¼šæ”¯æŒReactã€Vueã€Next.jsç­‰ä¸»æµå‰ç«¯æ¡†æ¶
- **ğŸ“Š æ™ºèƒ½ä¸ŠæŠ¥**ï¼šæ”¯æŒæ‰¹é‡ä¸ŠæŠ¥ã€å¤±è´¥é‡è¯•ã€è‡ªå®šä¹‰ä¸ŠæŠ¥ç­–ç•¥

## ğŸ“¦ å®‰è£…

> æ³¨æ„ï¼šé¡¹ç›®è¿˜åœ¨å®Œå–„ä¸­ï¼Œæš‚æœªå‘å¸ƒåˆ°npm

```bash
npm install @EzStars/EzMonitor
# æˆ–
pnpm add @EzStars/EzMonitor
# æˆ–
yarn add @EzStars/EzMonitor
```

## âš¡ å¿«é€Ÿå¼€å§‹

### åŸºç¡€ä½¿ç”¨

```typescript
import EzMonitor from '@EzStars/EzMonitor';

// åˆå§‹åŒ–ç›‘æ§SDK
const monitor = new EzMonitor({
  url: 'https://your-api.com/monitor',    // ä¸ŠæŠ¥åœ°å€ (å¿…å¡«)
  projectName: 'your-project',            // é¡¹ç›®åç§° (å¿…å¡«)
  appId: 'your-app-id',                   // é¡¹ç›®ID (å¿…å¡«)
  userId: 'user-123',                     // ç”¨æˆ·ID (å¿…å¡«)
});

// SDK åˆå§‹åŒ–åï¼Œä»¥ä¸‹åŠŸèƒ½å°†è‡ªåŠ¨å¯åŠ¨ï¼š
// âœ… PVç›‘æ§ - é¡µé¢è®¿é—®é‡ç»Ÿè®¡
// âœ… é”™è¯¯ç›‘æ§ - JSé”™è¯¯ã€èµ„æºé”™è¯¯æ•è·
// âœ… æ€§èƒ½ç›‘æ§ - é¡µé¢æ€§èƒ½æŒ‡æ ‡æ”¶é›†
// âœ… è¡Œä¸ºç›‘æ§ - ç”¨æˆ·äº¤äº’è¡Œä¸ºè®°å½•
// âœ… å±å¹•å½•åˆ¶ - ç”¨æˆ·æ“ä½œå½•åˆ¶ï¼ˆç”¨äºé”™è¯¯å›æ”¾ï¼‰
```

### é«˜çº§é…ç½®

```typescript
const monitor = new EzMonitor({
  // åŸºç¡€é…ç½®
  url: 'https://your-api.com/monitor',
  projectName: 'your-project',
  appId: 'your-app-id',
  userId: 'user-123',
  
  // ä¸ŠæŠ¥é…ç½®
  batchSize: 10,                          // æ‰¹é‡ä¸ŠæŠ¥å¤§å°ï¼Œé»˜è®¤10
  isAjax: true,                           // æ˜¯å¦ä½¿ç”¨Ajaxä¸ŠæŠ¥ï¼Œé»˜è®¤true
  
  // ç™½å±æ£€æµ‹é…ç½®
  containerElements: ['#app', '#root'],   // å®¹å™¨å…ƒç´ é€‰æ‹©å™¨
  skeletonElements: ['.skeleton'],        // éª¨æ¶å±å…ƒç´ é€‰æ‹©å™¨
  
  // SourceMapé…ç½®ï¼ˆç”¨äºé”™è¯¯æºç å®šä½ï¼‰
  enableSourceMap: true,                  // æ˜¯å¦å¯ç”¨SourceMapè§£æ
  sourceMapTimeout: 3000,                 // SourceMapè·å–è¶…æ—¶æ—¶é—´
  sourceMapEndpoint: 'https://your-api.com/sourcemap', // SourceMapæœåŠ¡ç«¯ç‚¹
  
  // å›è°ƒå‡½æ•°
  reportBefore: (data) => {
    console.log('ä¸ŠæŠ¥å‰:', data);
    // å¯ä»¥åœ¨è¿™é‡Œè¿‡æ»¤æˆ–ä¿®æ”¹æ•°æ®
    return data;
  },
  
  reportSuccess: (data) => {
    console.log('ä¸ŠæŠ¥æˆåŠŸ:', data);
  },
  
  reportFail: (error) => {
    console.error('ä¸ŠæŠ¥å¤±è´¥:', error);
  },
  
  reportAfter: (data) => {
    console.log('ä¸ŠæŠ¥å:', data);
  }
});
```

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½ä½¿ç”¨

### 1. PV ç›‘æ§ï¼ˆè‡ªåŠ¨å¯ç”¨ï¼‰

PV ç›‘æ§ä¼šè‡ªåŠ¨ç»Ÿè®¡é¡µé¢è®¿é—®é‡ï¼Œæ”¯æŒä¼ ç»Ÿé¡µé¢å’ŒSPAåº”ç”¨ï¼š

```typescript
// æ— éœ€é¢å¤–é…ç½®ï¼ŒSDKåˆå§‹åŒ–åè‡ªåŠ¨å¯åŠ¨
// ç›‘æ§ä»¥ä¸‹åœºæ™¯ï¼š
// - é¡µé¢é¦–æ¬¡åŠ è½½
// - Hashè·¯ç”±å˜åŒ– (#/home -> #/about)
// - History APIè·¯ç”±å˜åŒ– (/home -> /about)

// æŸ¥çœ‹PVç›‘æ§æ•°æ®ï¼ˆè°ƒè¯•ç”¨ï¼‰
console.log('é¡µé¢ä¿¡æ¯:', getPageInfo());
console.log('æ¥æºä¿¡æ¯:', getOriginInfo());
```

è¯¦ç»†æ–‡æ¡£ï¼š[PVç›‘æ§è¯¦è§£](./è¡Œä¸ºç›‘æ§/PVç›‘æ§.md)

### 2. è‡ªå®šä¹‰åŸ‹ç‚¹

```typescript
// è·å–è¡Œä¸ºç›‘æ§å®ä¾‹
const behavior = window.$SDK.Behaviour;

// å‘é€è‡ªå®šä¹‰ä¸šåŠ¡åŸ‹ç‚¹
behavior.customHandler({
  eventKey: 'button_click',               // äº‹ä»¶æ ‡è¯†
  eventAction: 'click',                   // äº‹ä»¶åŠ¨ä½œ
  eventValue: {                           // äº‹ä»¶æ•°æ®
    button_name: 'è´­ä¹°æŒ‰é’®',
    page: '/product/123',
    price: 99.99,
    user_type: 'premium'
  }
});
```

### 3. è·å–ç”¨æˆ·è¡Œä¸ºè½¨è¿¹

```typescript
// è·å–ç”¨æˆ·æœ€è¿‘çš„è¡Œä¸ºè®°å½•ï¼ˆé¢åŒ…å±‘å¯¼èˆªï¼‰
const breadcrumbs = window.$SDK.Behaviour.breadcrumbs.getAll();
console.log('ç”¨æˆ·è¡Œä¸ºè½¨è¿¹:', breadcrumbs);

// è·å–å±å¹•å½•åˆ¶æ•°æ®ï¼ˆç”¨äºé”™è¯¯å›æ”¾ï¼‰
import { getRecordScreenData } from '@EzStars/EzMonitor';
const recordData = getRecordScreenData();
console.log('å½•å±æ•°æ®:', recordData);
```

## ğŸ› ï¸ æ¡†æ¶é›†æˆç¤ºä¾‹

### Vue.js é¡¹ç›®

```typescript
// main.js
import { createApp } from 'vue';
import EzMonitor from '@EzStars/EzMonitor';
import App from './App.vue';

// åˆå§‹åŒ–ç›‘æ§
const monitor = new EzMonitor({
  url: 'https://api.example.com/monitor',
  projectName: 'vue-app',
  appId: 'vue-app-001',
  userId: localStorage.getItem('userId') || 'anonymous',
});

const app = createApp(App);
app.mount('#app');
```

### React é¡¹ç›®

```typescript
// index.js
import React from 'react';
import ReactDOM from 'react-dom/client';
import EzMonitor from '@EzStars/EzMonitor';
import App from './App';

// åˆå§‹åŒ–ç›‘æ§
const monitor = new EzMonitor({
  url: 'https://api.example.com/monitor',
  projectName: 'react-app',
  appId: 'react-app-001',
  userId: localStorage.getItem('userId') || 'anonymous',
});

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
```

### Next.js é¡¹ç›®

```typescript
// _app.js
import EzMonitor from '@EzStars/EzMonitor';
import { useEffect } from 'react';

function MyApp({ Component, pageProps }) {
  useEffect(() => {
    // å®¢æˆ·ç«¯åˆå§‹åŒ–ç›‘æ§
    if (typeof window !== 'undefined') {
      const monitor = new EzMonitor({
        url: 'https://api.example.com/monitor',
        projectName: 'nextjs-app',
        appId: 'nextjs-app-001',
        userId: 'user-123',
      });
    }
  }, []);

  return <Component {...pageProps} />;
}

export default MyApp;
```

## ğŸ—ï¸ é¡¹ç›®æ¶æ„

EzMonitoré‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œæ ¸å¿ƒæ¨¡å—åŒ…æ‹¬ï¼š

### é‡‡é›†å±‚ (Collection Layer)
- **Performance Plugin**: æ€§èƒ½æ•°æ®é‡‡é›† (FCPã€LCPã€FMPç­‰)
- **Error Plugin**: é”™è¯¯æ•°æ®é‡‡é›† (JSé”™è¯¯ã€èµ„æºé”™è¯¯ã€Promiseé”™è¯¯)
- **Behavior Plugin**: è¡Œä¸ºæ•°æ®é‡‡é›† (PVã€ç‚¹å‡»ã€è·¯ç”±è·³è½¬)
- **Exception Plugin**: å¼‚å¸¸æ•°æ®é‡‡é›† (ç™½å±ã€å¡é¡¿æ£€æµ‹)

### å¤„ç†å±‚ (Processing Layer)
- **æ•°æ®è¿‡æ»¤**: å»é‡ã€å»æ•ã€å¼‚å¸¸æ•°æ®è¿‡æ»¤
- **æ•°æ®é‡‡æ ·**: é‡‡æ ·ç­–ç•¥ã€æµé‡æ§åˆ¶
- **æ•°æ®å‹ç¼©**: å½•å±æ•°æ®å‹ç¼©ã€æ‰¹é‡æ•°æ®å‹ç¼©

### ä¸ŠæŠ¥å±‚ (Reporting Layer)
- **æ‰¹é‡ä¸ŠæŠ¥**: å‡å°‘ç½‘ç»œè¯·æ±‚ï¼Œæé«˜æ€§èƒ½
- **å¤±è´¥é‡è¯•**: ç½‘ç»œå¼‚å¸¸æ—¶çš„é‡è¯•æœºåˆ¶
- **ä¼˜å…ˆçº§é˜Ÿåˆ—**: é”™è¯¯æ•°æ®ä¼˜å…ˆä¸ŠæŠ¥

### æ ¸å¿ƒå±‚ (Core Layer)
- **EventBus**: äº‹ä»¶æ€»çº¿ï¼Œæ¨¡å—é—´é€šä¿¡
- **ReportQueue**: ä¸ŠæŠ¥é˜Ÿåˆ—ç®¡ç†
- **SandboxManager**: æ²™ç®±ç®¡ç†ï¼Œæ’ä»¶éš”ç¦»

## ğŸŒŸ ç‰¹è‰²åŠŸèƒ½

### æ™ºèƒ½ç™½å±æ£€æµ‹
```typescript
const monitor = new EzMonitor({
  // é…ç½®ç™½å±æ£€æµ‹
  containerElements: ['#app', '#root', '.main-content'],
  skeletonElements: ['.skeleton', '.loading'],
  // å½“æ£€æµ‹åˆ°ç™½å±æ—¶ä¼šè‡ªåŠ¨ä¸ŠæŠ¥
});
```

### SourceMap æºç å®šä½
```typescript
const monitor = new EzMonitor({
  enableSourceMap: true,                    // å¯ç”¨SourceMap
  sourceMapEndpoint: 'https://your-api.com/sourcemap',
  // é”™è¯¯ä¸ŠæŠ¥æ—¶ä¼šè‡ªåŠ¨è§£ææºç ä½ç½®
});
```

### é”™è¯¯å½•å±å›æ”¾
```typescript
// å‘ç”Ÿé”™è¯¯æ—¶ï¼Œå¯ä»¥è·å–ç”¨æˆ·æ“ä½œå½•å±
const recordData = getRecordScreenData();
// å½•å±æ•°æ®å¯ä»¥åœ¨åå°ç³»ç»Ÿä¸­å›æ”¾ï¼Œå¿«é€Ÿå®šä½é—®é¢˜
```

## ğŸ“Š æ•°æ®ç±»å‹è¯´æ˜

æ‰€æœ‰ç›‘æ§æ•°æ®éƒ½åŒ…å«ä»¥ä¸‹åŸºç¡€å­—æ®µï¼š

```typescript
interface BaseData {
  type: 'performance' | 'error' | 'behavior' | 'exception';
  subType: string;              // å…·ä½“ç±»å‹
  timestamp: number;            // æ—¶é—´æˆ³
  // ... å…¶ä»–å…·ä½“å­—æ®µ
}
```

### ä¸»è¦æ•°æ®ç±»å‹

- **PVæ•°æ®** (`behavior.pv`): é¡µé¢è®¿é—®ç»Ÿè®¡
- **ç‚¹å‡»æ•°æ®** (`behavior.click`): ç”¨æˆ·ç‚¹å‡»è¡Œä¸º
- **è·¯ç”±æ•°æ®** (`behavior.routerChange`): è·¯ç”±è·³è½¬è®°å½•
- **è‡ªå®šä¹‰åŸ‹ç‚¹** (`behavior.tracker`): ä¸šåŠ¡è‡ªå®šä¹‰äº‹ä»¶
- **æ€§èƒ½æ•°æ®** (`performance.*`): é¡µé¢æ€§èƒ½æŒ‡æ ‡
- **é”™è¯¯æ•°æ®** (`error.*`): å„ç±»é”™è¯¯ä¿¡æ¯

## ğŸ” è°ƒè¯•å’Œç›‘æ§

### å¼€å‘ç¯å¢ƒè°ƒè¯•
```typescript
const monitor = new EzMonitor({
  // ... å…¶ä»–é…ç½®
  reportBefore: (data) => {
    console.group(`ğŸ“Š ${data.type}.${data.subType}`);
    console.log('æ•°æ®:', data);
    console.log('æ—¶é—´:', new Date(data.timestamp).toLocaleString());
    console.groupEnd();
    return data;
  }
});
```

### ç”Ÿäº§ç¯å¢ƒç›‘æ§
```typescript
const monitor = new EzMonitor({
  // ... å…¶ä»–é…ç½®
  reportFail: (error) => {
    // ä¸ŠæŠ¥å¤±è´¥æ—¶çš„é™çº§å¤„ç†
    console.error('ç›‘æ§æ•°æ®ä¸ŠæŠ¥å¤±è´¥:', error);
    // å¯ä»¥è€ƒè™‘é™çº§åˆ°å…¶ä»–ä¸ŠæŠ¥æ–¹å¼
  }
});
```

## ğŸ“š è¯¦ç»†æ–‡æ¡£

- [PVç›‘æ§è¯¦è§£](./è¡Œä¸ºç›‘æ§/PVç›‘æ§.md) - é¡µé¢è®¿é—®é‡ç›‘æ§è¯¦ç»†æŒ‡å—
- [ç”¨æˆ·è¡Œä¸ºæ”¶é›†](./è¡Œä¸ºç›‘æ§/ç”¨æˆ·è¡Œä¸ºæ”¶é›†.md) - ç”¨æˆ·è¡Œä¸ºæ•°æ®æ”¶é›†
- [é”™è¯¯å½•å±å›æ”¾](./è¡Œä¸ºç›‘æ§/é”™è¯¯å½•å±å›æ”¾.md) - å±å¹•å½•åˆ¶å’Œé”™è¯¯å›æ”¾
- [æ€§èƒ½ç›‘æ§](./æ€§èƒ½ç›‘æ§/æ€§èƒ½ç›‘æ§.md) - é¡µé¢æ€§èƒ½ç›‘æ§æŒ‡å—
- [é”™è¯¯ç›‘æ§](./é”™è¯¯ç›‘æ§/) - å„ç±»é”™è¯¯ç›‘æ§è¯¦è§£
- [æ™ºèƒ½ä¸ŠæŠ¥æ–¹æ¡ˆ](./æ•°æ®ä¸ŠæŠ¥/æ™ºèƒ½ä¸ŠæŠ¥æ–¹æ¡ˆ.md) - æ•°æ®ä¸ŠæŠ¥ç­–ç•¥ä¼˜åŒ–

## ğŸ› ï¸ å¼€å‘æµ‹è¯•

```bash
# å…‹éš†é¡¹ç›®
git clone https://github.com/EzStars/EzMonitor.git

# å®‰è£…ä¾èµ–
pnpm install

# æ„å»ºSDK
pnpm run build

# è¿è¡Œæµ‹è¯•
pnpm run test
```

## ğŸ’¡ æœ€ä½³å®è·µ

1. **åˆç†é…ç½®æ‰¹é‡ä¸ŠæŠ¥**: æ ¹æ®ä¸šåŠ¡é‡çº§è°ƒæ•´ `batchSize`
2. **è¿‡æ»¤æ•æ„Ÿä¿¡æ¯**: åœ¨ `reportBefore` ä¸­è¿‡æ»¤ç”¨æˆ·æ•æ„Ÿæ•°æ®
3. **ç›‘æ§æ€§èƒ½å½±å“**: å®šæœŸæ£€æŸ¥ç›‘æ§ä»£ç å¯¹é¡µé¢æ€§èƒ½çš„å½±å“
4. **é”™è¯¯åˆ†çº§å¤„ç†**: åŒºåˆ†è‡´å‘½é”™è¯¯å’Œæ™®é€šé”™è¯¯çš„ä¸ŠæŠ¥ç­–ç•¥
5. **æ•°æ®éšç§åˆè§„**: ç¡®ä¿æ”¶é›†çš„æ•°æ®ç¬¦åˆéšç§æ”¿ç­–è¦æ±‚

## â“ å¸¸è§é—®é¢˜

**Q: SDK ä¼šå½±å“é¡µé¢æ€§èƒ½å—ï¼Ÿ**  
A: SDK é‡‡ç”¨å¼‚æ­¥ä¸ŠæŠ¥å’Œæ‰¹é‡å¤„ç†ï¼Œå¯¹é¡µé¢æ€§èƒ½å½±å“æå°ï¼ˆ<1msï¼‰

**Q: å¦‚ä½•åœ¨SPAåº”ç”¨ä¸­ä½¿ç”¨ï¼Ÿ**  
A: SDK è‡ªåŠ¨æ”¯æŒ Hash å’Œ History æ¨¡å¼çš„è·¯ç”±ç›‘æ§ï¼Œæ— éœ€é¢å¤–é…ç½®

**Q: æ•°æ®ä¸ŠæŠ¥å¤±è´¥æ€ä¹ˆåŠï¼Ÿ**  
A: SDK å†…ç½®é‡è¯•æœºåˆ¶ï¼Œå¹¶æä¾› `reportFail` å›è°ƒè¿›è¡Œè‡ªå®šä¹‰å¤„ç†

**Q: å¦‚ä½•è‡ªå®šä¹‰æ•°æ®è¿‡æ»¤ï¼Ÿ**  
A: ä½¿ç”¨ `reportBefore` å›è°ƒå‡½æ•°ï¼Œå¯ä»¥åœ¨ä¸ŠæŠ¥å‰ä¿®æ”¹æˆ–è¿‡æ»¤æ•°æ®

## ğŸ¤ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»ï¼š

- **GitHub Issues**: [https://github.com/EzStars/EzMonitor/issues](https://github.com/EzStars/EzMonitor/issues)
- **æ–‡æ¡£ç½‘ç«™**: [é¡¹ç›®æ–‡æ¡£åœ°å€]
- **æŠ€æœ¯äº¤æµ**: [æŠ€æœ¯äº¤æµç¾¤]

EzMonitor - è®©å‰ç«¯ç›‘æ§æ›´ç®€å•ï¼ ğŸš€
