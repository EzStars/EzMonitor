name: Release

on:
  push:
    branches:
      - main

concurrency: ${{ github.workflow }}-${{ github.ref }}

permissions:
  contents: write      # å…è®¸æ¨é€ä»£ç å’Œæ ‡ç­¾
  pull-requests: write # å…è®¸åˆ›å»ºå’Œæ›´æ–° PR  
  issues: write        # å…è®¸åˆ›å»º issues
  id-token: write      # å…è®¸ OIDC token è¯·æ±‚

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          # This makes Actions fetch all Git history so that Changesets can generate changelogs with the correct commits
          fetch-depth: 0
          # Use GITHUB_TOKEN for authentication
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.4.1

      - name: Setup Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Build SDK v2 Package
        run: pnpm --filter @ezstars/monitor-sdkv2 run build

      - name: Version packages and publish to npm
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰ changeset æ–‡ä»¶
          if [ -n "$(find .changeset -name '*.md' -not -name 'README.md' -print -quit)" ]; then
            echo "ğŸ“¦ Found changesets, updating versions..."
            pnpm changeset:version
            
            echo "ğŸ“ Committing version changes..."
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add .
            git commit -m "chore: version packages [skip ci]" || echo "No changes to commit"
            git push origin main
            
            echo "ğŸš€ Publishing to npm..."
            pnpm changeset:publish
            
            echo "âœ… Release completed!"
          else
            echo "ğŸ“­ No changesets found, skipping release"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
