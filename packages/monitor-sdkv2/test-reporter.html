<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reporter åŠŸèƒ½æµ‹è¯•</title>
  <style>
    body {
      font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, monospace;
      max-width: 900px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    .test-section {
      margin-bottom: 25px;
      padding: 15px;
      background: #f9f9f9;
      border-left: 3px solid #4CAF50;
      border-radius: 4px;
    }
    .test-title {
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    button:hover {
      background: #45a049;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .log {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 4px;
      max-height: 400px;
      overflow-y: auto;
      font-size: 13px;
      line-height: 1.5;
      margin-top: 20px;
    }
    .log-entry {
      margin: 5px 0;
    }
    .log-success { color: #4CAF50; }
    .log-error { color: #f44336; }
    .log-info { color: #2196F3; }
    .log-warning { color: #FF9800; }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    .stat-value {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .stat-label {
      font-size: 14px;
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸš€ Reporter åŠŸèƒ½æµ‹è¯•</h1>
    <p class="subtitle">EzMonitor SDK v2 - æ•°æ®ä¸ŠæŠ¥å±‚æµ‹è¯•</p>

    <div class="stats">
      <div class="stat-card">
        <div class="stat-value" id="totalReports">0</div>
        <div class="stat-label">æ€»ä¸ŠæŠ¥æ¬¡æ•°</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="successCount">0</div>
        <div class="stat-label">æˆåŠŸæ¬¡æ•°</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="failCount">0</div>
        <div class="stat-label">å¤±è´¥æ¬¡æ•°</div>
      </div>
    </div>

    <div class="test-section">
      <div class="test-title">ğŸ“¤ åŸºç¡€ä¸ŠæŠ¥æµ‹è¯•</div>
      <button onclick="testBasicReport()">å‘é€å•æ¡æ•°æ®</button>
      <button onclick="testBatchReport()">å‘é€æ‰¹é‡æ•°æ®</button>
      <button onclick="testLargeData()">å‘é€å¤§æ•°æ® (æµ‹è¯•ä¼ è¾“ç­–ç•¥)</button>
    </div>

    <div class="test-section">
      <div class="test-title">ğŸ”„ ç”Ÿå‘½å‘¨æœŸæµ‹è¯•</div>
      <button onclick="testLifecycleHooks()">æµ‹è¯•ç”Ÿå‘½å‘¨æœŸé’©å­</button>
      <button onclick="testRetry()">æµ‹è¯•å¤±è´¥é‡è¯•</button>
    </div>

    <div class="test-section">
      <div class="test-title">ğŸ¯ é«˜çº§åŠŸèƒ½</div>
      <button onclick="testForceXHR()">å¼ºåˆ¶ä½¿ç”¨ XHR</button>
      <button onclick="testPageTracking()">è‡ªåŠ¨é¡µé¢è¿½è¸ª</button>
      <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <div class="log" id="log"></div>
  </div>

  <script type="module">
    import { createSDK, TrackingPlugin } from './dist/index.esm.js';

    // å…¨å±€å˜é‡
    window.sdk = null;
    window.trackingPlugin = null;
    window.stats = {
      total: 0,
      success: 0,
      fail: 0
    };

    // æ—¥å¿—å‡½æ•°
    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function updateStats() {
      document.getElementById('totalReports').textContent = window.stats.total;
      document.getElementById('successCount').textContent = window.stats.success;
      document.getElementById('failCount').textContent = window.stats.fail;
    }

    // åˆå§‹åŒ– SDK
    async function initSDK(config = {}) {
      if (window.sdk) {
        await window.sdk.destroy();
      }

      window.sdk = createSDK({
        appId: 'test-app-browser',
        userId: 'test-user-123',
        reportUrl: 'https://httpbin.org/post', // ä½¿ç”¨å…¬å…±æµ‹è¯•API
        debug: true,
        enableRetry: true,
        beforeReport: (data) => {
          log('â³ å‡†å¤‡ä¸ŠæŠ¥æ•°æ®...', 'info');
        },
        onReportSuccess: (data) => {
          window.stats.total++;
          window.stats.success++;
          updateStats();
          log('âœ… ä¸ŠæŠ¥æˆåŠŸï¼', 'success');
        },
        onReportError: (data, error) => {
          window.stats.total++;
          window.stats.fail++;
          updateStats();
          log(`âŒ ä¸ŠæŠ¥å¤±è´¥: ${error.message}`, 'error');
        },
        afterReport: (data) => {
          log('ğŸ ä¸ŠæŠ¥æµç¨‹ç»“æŸ', 'info');
        },
        ...config
      });

      window.trackingPlugin = new TrackingPlugin({
        enableBatch: false,
        autoTrackPage: false,
      });

      window.sdk.use(window.trackingPlugin);
      await window.sdk.init();
      await window.sdk.start();

      log('ğŸ‰ SDK åˆå§‹åŒ–å®Œæˆ', 'success');
    }

    // æµ‹è¯•å‡½æ•°
    window.testBasicReport = async function() {
      log('========== å¼€å§‹ï¼šåŸºç¡€ä¸ŠæŠ¥æµ‹è¯• ==========', 'info');
      await initSDK();

      window.trackingPlugin.track('test_event', {
        action: 'click',
        target: 'button',
        timestamp: Date.now()
      });

      log('å·²è§¦å‘ track() è°ƒç”¨', 'info');
    };

    window.testBatchReport = async function() {
      log('========== å¼€å§‹ï¼šæ‰¹é‡ä¸ŠæŠ¥æµ‹è¯• ==========', 'info');
      await initSDK();

      // é‡æ–°åˆå§‹åŒ–ä¸ºæ‰¹é‡æ¨¡å¼
      window.trackingPlugin = new TrackingPlugin({
        enableBatch: true,
        batchSize: 3,
        batchInterval: 5000,
      });

      await window.sdk.destroy();
      window.sdk = createSDK({
        appId: 'test-app',
        reportUrl: 'https://httpbin.org/post',
        debug: true,
      });

      window.sdk.use(window.trackingPlugin);
      await window.sdk.init();
      await window.sdk.start();

      log('è§¦å‘ 3 ä¸ªäº‹ä»¶...', 'info');
      window.trackingPlugin.track('batch_event_1', { value: 1 });
      window.trackingPlugin.track('batch_event_2', { value: 2 });
      window.trackingPlugin.track('batch_event_3', { value: 3 });

      log('æ‰¹é‡ä¸ŠæŠ¥å°†åœ¨è¾¾åˆ°é˜ˆå€¼æˆ–å®šæ—¶å™¨è§¦å‘æ—¶æ‰§è¡Œ', 'warning');
    };

    window.testLargeData = async function() {
      log('========== å¼€å§‹ï¼šå¤§æ•°æ®ä¼ è¾“æµ‹è¯• ==========', 'info');
      await initSDK();

      // ç”Ÿæˆå¤§é‡æ•°æ®
      const largeData = {
        items: Array(1000).fill(null).map((_, i) => ({
          id: i,
          name: `item_${i}`,
          data: 'x'.repeat(100)
        }))
      };

      window.trackingPlugin.track('large_data_event', largeData);
      log(`ç”Ÿæˆäº†çº¦ ${JSON.stringify(largeData).length} å­—èŠ‚çš„æ•°æ®`, 'info');
      log('æ ¹æ®å¤§å°ï¼ŒReporter ä¼šé€‰æ‹©æœ€ä½³ä¼ è¾“æ–¹å¼', 'warning');
    };

    window.testLifecycleHooks = async function() {
      log('========== å¼€å§‹ï¼šç”Ÿå‘½å‘¨æœŸé’©å­æµ‹è¯• ==========', 'info');
      let hooksCalled = [];

      await initSDK({
        beforeReport: (data) => {
          hooksCalled.push('beforeReport');
          log('ğŸ”µ beforeReport é’©å­è¢«è°ƒç”¨', 'info');
        },
        onReportSuccess: (data) => {
          hooksCalled.push('onReportSuccess');
          log('ğŸŸ¢ onReportSuccess é’©å­è¢«è°ƒç”¨', 'success');
        },
        afterReport: (data) => {
          hooksCalled.push('afterReport');
          log('ğŸŸ£ afterReport é’©å­è¢«è°ƒç”¨', 'info');
          setTimeout(() => {
            log(`âœ¨ å…±è°ƒç”¨äº† ${hooksCalled.length} ä¸ªé’©å­: ${hooksCalled.join(', ')}`, 'success');
          }, 100);
        },
      });

      window.trackingPlugin.track('hook_test', { test: true });
    };

    window.testRetry = async function() {
      log('========== å¼€å§‹ï¼šå¤±è´¥é‡è¯•æµ‹è¯• ==========', 'warning');

      await initSDK({
        reportUrl: 'https://invalid-domain-that-does-not-exist.com/api',
        enableRetry: true,
        retryStrategy: {
          maxRetries: 3,
          initialDelay: 1000,
          backoffMultiplier: 2,
        },
      });

      window.trackingPlugin.track('retry_test', { willFail: true });
      log('å·²å‘é€åˆ°æ— æ•ˆåœ°å€ï¼Œå°†è§¦å‘é‡è¯•æœºåˆ¶...', 'warning');
      log('è¯·è§‚å¯Ÿæ§åˆ¶å°è¾“å‡ºæŸ¥çœ‹é‡è¯•è¿‡ç¨‹', 'info');
    };

    window.testForceXHR = async function() {
      log('========== å¼€å§‹ï¼šå¼ºåˆ¶ XHR æµ‹è¯• ==========', 'info');

      await initSDK({
        forceXHR: true,
      });

      window.trackingPlugin.track('force_xhr_test', {
        mode: 'xhr',
        data: 'small data but force xhr'
      });

      log('å·²è®¾ç½® forceXHR: true', 'info');
      log('å³ä½¿æ•°æ®å¾ˆå°ï¼Œä¹Ÿä¼šä½¿ç”¨ XHR ä¼ è¾“', 'warning');
    };

    window.testPageTracking = async function() {
      log('========== å¼€å§‹ï¼šè‡ªåŠ¨é¡µé¢è¿½è¸ªæµ‹è¯• ==========', 'info');

      window.trackingPlugin = new TrackingPlugin({
        enableBatch: false,
        autoTrackPage: true, // å¯ç”¨è‡ªåŠ¨é¡µé¢è¿½è¸ª
      });

      await window.sdk.destroy();
      window.sdk = createSDK({
        appId: 'test-app',
        reportUrl: 'https://httpbin.org/post',
        debug: true,
      });

      window.sdk.use(window.trackingPlugin);
      await window.sdk.init();
      await window.sdk.start();

      log('âœ… è‡ªåŠ¨é¡µé¢è¿½è¸ªå·²å¯ç”¨', 'success');
      log('å½“å‰é¡µé¢è®¿é—®å·²è¢«è®°å½•', 'info');
      log('å¯ä»¥å°è¯•ä¿®æ”¹ URL hash æ¥è§¦å‘æ–°çš„é¡µé¢è¿½è¸ª', 'warning');
    };

    window.clearLog = function() {
      document.getElementById('log').innerHTML = '';
      log('æ—¥å¿—å·²æ¸…ç©º', 'info');
    };

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    log('ğŸŒŸ Reporter æµ‹è¯•é¡µé¢å·²åŠ è½½', 'success');
    log('ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•å„é¡¹åŠŸèƒ½', 'info');
    log('----------------------------------------', 'info');
  </script>
</body>
</html>
